<%@ page language="java" contentType="text/html; charset=utf-8"
    pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>   
<%@ include  file="./../../../common/header.jsp"%> 
<!-- 二级菜单 begin -->
<div class="sidebar" id="sidebar">
	<div class="sidebar-shortcuts" id="sidebar-shortcuts">
		<div class="sidebar-shortcuts-large" id="sidebar-shortcuts-large">
			<div class="icon-text"> <i class="icon-truck"></i> <span> 车辆管理 </span></div>
		</div>
	</div>
	<!-- #sidebar-shortcuts -->
	<ul class="nav nav-list">
		<li> <a href="${pageContext.request.contextPath}/ev/manufacturer/showList"> <i class="icon-home"></i> <span class="menu-text">生产厂家 </span> </a> </li>
				<li> <a href="${pageContext.request.contextPath}/notFount"> <i class="icon-flag"></i> <span class="menu-text">车队信息 </span> </a> </li>
		<li> <a href="${pageContext.request.contextPath}/ev/driver/showList"> <i class="icon-user"></i> <span class="menu-text">驾驶员信息 </span> </a> </li>
		<li> <a href="${pageContext.request.contextPath}/enterprise/bus/stop/busStopList"> <i class="icon-map-marker"></i> <span class="menu-text">公交站点管理</span> </a> </li>
		<li class="active"> <a href="${pageContext.request.contextPath}/enterprise/bus/line/busLineList"> <i class="icon-road"></i> <span class="menu-text">公交线路管理</span> </a> </li>
		<li> <a href="${pageContext.request.contextPath}/ev/vehicle/showList"> <i class="icon-truck"></i> <span class="menu-text">车辆信息 </span> </a> </li>
	</ul>
	<!-- /.nav-list -->
	<div class="sidebar-collapse" id="sidebar-collapse">
		<i class="icon-double-angle-left" data-icon1="icon-double-angle-left"
			data-icon2="icon-double-angle-right"></i>
	</div>
</div>
<!-- 二级菜单 end -->  
<div class="main-content">
	<div class="breadcrumbs" id="breadcrumbs">
	    <ul class="breadcrumb">
		    <li><i class="icon-home home-icon"></i><a href="#">首页</a></li>
			<li class="active">公交线路信息</li>
			<li class="active">公交线路添加</li>
		</ul>
	</div>
	<div class="page-content">
	   <div class="page-header">
		    <h1>
				公交线路
				<small> 
				    <i class="icon-double-angle-right"></i>添加公交线路
				</small>
			</h1>
		</div><!-- /.page-header -->
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-body">
				  <form  class="form-inline" id="busLineForm">
					<div class="row" style="height: 30px;padding-left: 20px;">
						 <div class="form-group">
						     <label class="control-label">线路名称：</label>
						 	 <input type="text" id="busLineName"  style="width:200px;" name="busLineName"  placeholder="..线路名称" value="${busLine.busLineName}" />
						 	 <input type="hidden"  id="busLineId"/>
						</div>
						 <span id="error_busLineName" style="color: red"></span>
					</div>
				    <div class="row" style="height: 30px;padding-left: 20px;margin-top: 15px;">
				        <div class="form-group">
						    <label class="control-label">站点名称：</label>
							<input type="text" style="width:200px;" id="busStopName"  placeholder="..站点名称"/>
						    <button type="button" style="height: 30px; width: 50px;color:#FFF;border:none; background-color:#42aaec;" onclick="refreshBusStop()">
							   <i class="icon-search"></i>
							</button>
						</div>
					</div>
					<table class="table">
						<tbody>
					     	<tr>
					        	<td align="right" style="width: 50%;border-top:0;">
					             	<select id="sel_all_area"  multiple="multiple" size="10" style="width:100%;height:200px">
					                   <c:forEach items="${busStops}" var="busStop" varStatus="status">
					                 	    <option value="${busStop.id }">${busStop.busStopName }</option>
					                 	</c:forEach>
					                 </select>
					         	 </td>
					         	 <td style="width: 120px;border-top: 0; vertical-align: middle;">
					         	 	<button type="button"  id="add" class="btn btn-primary icon-arrow-right">添加</button>
					         	 	<button type="button" id="delete" class="btn btn-primary icon-arrow-left" style="margin-top: 20px;">移除</button>
					         	 </td>
					         	 <td style="width: 50%;border-top:0;">
					                 <div style="margin-bottom: 2px;">
					                 	  <select id="sel_selected_areas" name="selectBusStop" multiple="multiple" size="10" style="width:100%;height: 200px;">
					             	 </select>
					                 </div>
					                  <span id="error-selectBusStop" style="color: red"></span>
					         	 </td>
					     	</tr>
				       	</tbody>
				    </table>
				    <div class="form-group">
					    <div class="col-sm-offset-9 col-sm-12">
						    <input type="submit" class="btn btn-primary" value="保存" />&nbsp;&nbsp;&nbsp;&nbsp;
							<a href="#" class="btn btn-success " onclick="goback()">返回</a>
						</div>
					</div>
				</form>
				</div>
			</div>
		</div> <!-- class:row -->
	</div>
</div>
<%@ include  file="./../../../common/footer.jsp"%>
<script>
$(function(){
	$("#busLineForm").validate({
		rules: {
			busLineName:{
				required:true,
				rangelength:[2,20],
				isContainsSpecialChar:true,
			    remote:{
					url:"${pageContext.request.contextPath}/enterprise/bus/line/checkBusLineName",
					type: "post",
				    dataType: "json",
				    data: {
				    	busLineName: function() {
				            return $("#busLineName").val();
				        },
				        id: function() {
				            return $("#busLineId").val();
				        }
				    },
				}
			}
		},
		messages:{
			busLineName:{
				required:"*请输入线路名称",
				rangelength:"*线路名称长度为2~20个字符",
				isContainsSpecialChar:"*线路名称只能由中文、英文",
			    remote:"*线路名称已存在！"
			}
		},
		errorPlacement: function(error, element) {
			error.appendTo(element.parent().siblings("span"));
		},
		submitHandler:function(){
			var busStopArray = busStopList();
			$("#error-selectBusStop").text("")
			if(busStopArray == null || "" == busStopArray){
				$("#error-selectBusStop").text("*站点信息不能为空")
				return false;	
			}
			 $.ajax({
				 type:"POST",
				 url:"${pageContext.request.contextPath}/enterprise/bus/line/saveOrUpdateBusLine",
				 data:{"busStopList":busStopArray,"busLineName":$("#busLineName").val(),"id":$("#busLineId").val()},
				 success:function(msg){
					 if(msg){
						 alert("保存线路信息成功");
						 goback();
					 }else{
						 alert("保存线路信息失败");
					 }
				 },
				 error: function () {
		        	alert("保存线路信息失败");
		    	}	
			}); 
		}
	});
});

function goback(){
	window.location.href = "${pageContext.request.contextPath}/enterprise/bus/line/busLineList";
}

$("#add").click(function(){
	if($("#sel_all_area option:selected").length > 0)  {  
　　　　　　　　$("#sel_all_area option:selected").each(function(){  
　　　　           $("#sel_selected_areas").append("<option value='"+$(this).val()+"'>"+$(this).text()+"</option");  
                   $(this).remove();　  
               });  
　　　　}  else {  
　　　　　　　alert("请选择要添加路线节点！");  
　　　　}  
});  

$("#delete").click(function(){  
　　　　if($("#sel_selected_areas option:selected").length > 0)  {  
　　　　    $("#sel_selected_areas option:selected").each(function(){  
　　　　　　　　　$("#sel_all_area").append("<option value='"+$(this).val()+"'>"+$(this).text()+"</option");  
　　　　　　　　　$(this).remove();　  
　　　　　　})  
　　　　} else {  
　　　　　　alert("请选择要删除的路线节点！");  
　　　　}  
}); 

function refreshBusStop(){
	$.ajax({
		 type:"POST",
		 url:"${pageContext.request.contextPath}/enterprise/bus/line/refreshBusStop",
		 data:{"name":$("#busStopName").val()},
		 success:function(data){
			 var htmlStr;
			 var dataObj;
			 for(var i = 0;i<data.length;i++){
	             dataObj = data[i];
	        	 htmlStr = htmlStr + "<option value='"+dataObj["id"]+"'>"+dataObj["busStopName"]+"</option>"
	         }
	         $("#sel_all_area").empty();
	         $("#sel_all_area").append(htmlStr);
		 }
	});
}

//获取站点信息
function busStopList(){
	var busStopInfo = [];
	var busStopSize = $("#sel_selected_areas option").length;
	if(busStopSize  > 0){
		$($("#sel_selected_areas option")).each(function(){
			busStopInfo.push($(this).val());
		});
	}
	return busStopInfo.toString();
}
</script>